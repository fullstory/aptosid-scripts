#!/bin/sh

if [ "$(id -u)" -ne 0 ]; then
	[ -x /usr/bin/su-me ] && DISPLAY="" exec su-me "$0" "$@"

	echo Error: You must be root to run this script!
	exit 1
fi

SWAPUUID=$(blkid -t TYPE=swap -o value -s UUID | head -n1)

if echo "${SWAPUUID}" | egrep -q '^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$'; then
	echo "Using UUID=${SWAPUUID} for resume."
	if [ -d /etc/initramfs-tools/conf.d/ ] && \
		! grep -s -q ${SWAPUUID} /etc/initramfs-tools/conf.d/resume; then
		# (over)write configuration
		echo "Overwriting /etc/initramfs-tools/conf.d/resume..."
		echo "RESUME=UUID=${SWAPUUID}" > /etc/initramfs-tools/conf.d/resume
		
		if [ -x /usr/sbin/update-initramfs ] && \
			[ -e /etc/initramfs-tools/initramfs.conf ]; then
			# rebuild the initramfs
			echo "Updating initial ramdisk for new configuration..."
			update-initramfs -u -k "$(uname -r)"
		fi

		if [ -w /boot/grub/menu.lst ] && \
			egrep -q '# (defopt|kopt).*resume=[^[:space:]]+' /boot/grub/menu.lst; then
			# update grub menu.lst
			echo "Updating grub configuration /boot/grub/menu.lst..."
			# remove all resume= lines from grub menu.lst
			sed -i '/^# \(defopt\|kopt\)/s/[[:space:]]*resume=[^[:space:]]\+//' /boot/grub/menu.lst
			update-grub
		fi
	else
		echo "No need to update /etc/initramfs-tools/conf.d/resume..."
	fi
else
	echo "Error: No swap partition UUID found by blkid(8)."
	exit 2
fi
